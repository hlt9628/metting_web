<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI面试助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb', // 主色调：蓝色，代表专业和信任
                        secondary: '#fbbf24', // 辅助色：黄色，代表活力和友好
                        dark: '#1e293b', // 深色
                        light: '#f8fafc', // 浅色
                        neutral: '#64748b', // 中性色
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            /* 通用滚动条样式（可选） */
            .scroll-style {
                scrollbar-width: thin; /* 火狐浏览器 */
                scrollbar-color: #d1d5db #e5e7eb; /* 火狐浏览器颜色 */
            }
            .scroll-style::-webkit-scrollbar {
                width: 6px; /* 滚动条宽度 */
            }
            .scroll-style::-webkit-scrollbar-track {
                background: #e5e7eb; /* 滚动条轨道背景 */
            }
            .scroll-style::-webkit-scrollbar-thumb {
                background: #d1d5db; /* 滚动条滑块背景 */
                border-radius: 3px;
            }
        }
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .transition-custom {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .hover-scale {
                transition: transform 0.2s ease-in-out;
            }
            .hover-scale:hover {
                transform: scale(1.03);
            }
            .bg-gradient-primary {
                background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%);
            }
            .bg-gradient-secondary {
                background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            }
            .animate-float {
                animation: float 6s ease-in-out infinite;
            }
            @keyframes float {
                0% { transform: translateY(0px); }
                50% { transform: translateY(-15px); }
                100% { transform: translateY(0px); }
            }
            .animate-fade-in {
                animation: fadeIn 0.5s ease-in-out forwards;
            }
            @keyframes fadeIn {
                0% { opacity: 0; transform: translateY(10px); }
                100% { opacity: 1; transform: translateY(0); }
            }
            .animate-pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            
            /* 进度条样式 */
            .progress-container {
                background: white;
                padding: 0.5rem 1rem;
                border-radius: 0.5rem;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            .progress-steps {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .step {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.25rem;
            }
            
            .step-icon {
                width: 2rem;
                height: 2rem;
                border-radius: 50%;
                background: #e5e7eb;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #6b7280;
                transition: all 0.3s ease;
            }
            
            .step.active .step-icon {
                background: #2563eb;
                color: white;
                animation: pulse 2s infinite;
            }
            
            .step-label {
                font-size: 0.75rem;
                color: #6b7280;
                transition: all 0.3s ease;
            }
            
            .step.active .step-label {
                color: #2563eb;
                font-weight: 500;
            }
            
            .step-line {
                width: 2rem;
                height: 2px;
                background: #e5e7eb;
                transition: all 0.3s ease;
            }
            
            .step.active + .step-line {
                background: #2563eb;
            }
            
            @keyframes pulse {
                0% {
                    box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4);
                }
                70% {
                    box-shadow: 0 0 0 6px rgba(37, 99, 235, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
                }
            }
        }
    </style>
</head>
<body class="font-inter bg-light text-dark antialiased">
<!-- 开始面试遮罩层 -->
<div id="startOverlay" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
    <div class="practice-card-area relative w-full max-w-4xl mx-4 bg-white rounded-2xl shadow-2xl overflow-hidden animate-fade-in">
        <!-- 背景装饰 -->
        <div class="absolute -right-10 -top-10 w-64 h-64 bg-primary/10 rounded-full blur-3xl"></div>
        <div class="absolute -left-20 bottom-0 w-80 h-80 bg-secondary/10 rounded-full blur-3xl"></div>

        <div class="relative p-8 md:p-12">
            <div class="text-center mb-10">
                <h1 class="practice-title text-[clamp(1.75rem,3vw,2.5rem)] font-bold text-dark mb-4">面试押题</h1>
                <p class="practice-desc text-neutral text-lg max-w-2xl mx-auto">基于你的公司、岗位JD、简历信息进行押题</p>
            </div>

            <div class="practice-list grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                <!-- 面试类型卡片 -->
                <div class="practice-item bg-white rounded-xl shadow-lg p-6 hover-scale cursor-pointer border border-gray-100">
                    <div class="flex items-start">
                        <div class="practice-icon flex-shrink-0 w-12 h-12 rounded-full bg-blue-100 text-primary flex items-center justify-center text-xl mb-2">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div class="ml-4">
                            <div class="flex items-center">
                                <h3 class="practice-name font-bold text-lg">自我介绍</h3>
                                <span class="practice-tag ml-2 bg-blue-100 text-primary text-xs px-2 py-1 rounded-full">大厂</span>
                            </div>
                            <p class="practice-desc2 text-sm text-neutral mt-2">帮你构思有竞争力的自我介绍</p>
                        </div>
                    </div>
                </div>

                <div class="practice-item bg-white rounded-xl shadow-lg p-6 hover-scale cursor-pointer border border-gray-100">
                    <div class="flex items-start">
                        <div class="practice-icon flex-shrink-0 w-12 h-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xl mb-2">
                            <i class="fa-solid fa-file"></i>
                        </div>
                        <div class="ml-4">
                            <div class="flex items-center">
                                <h3 class="practice-name font-bold text-lg">项目介绍</h3>
                            </div>
                            <p class="practice-desc2 text-sm text-neutral mt-2">训练有亮点的项目介绍及追问应对</p>
                        </div>
                    </div>
                </div>

                <div class="practice-item bg-white rounded-xl shadow-lg p-6 hover-scale cursor-pointer border border-gray-100">
                    <div class="flex items-start">
                        <div class="practice-icon flex-shrink-0 w-12 h-12 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-xl mb-2">
                            <i class="fa-solid fa-money-bill-wave"></i>
                        </div>
                        <div class="ml-4">
                            <div class="flex items-center">
                                <h3 class="practice-name font-bold text-lg">薪资谈判</h3>
                                <span class="practice-tag ml-2 bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded-full">外企</span>
                            </div>
                            <p class="practice-desc2 text-sm text-neutral mt-2">锻炼谈薪技巧，助你拿取目标薪资</p>
                        </div>
                    </div>
                </div>

                <div class="practice-item bg-white rounded-xl shadow-lg p-6 hover-scale cursor-pointer border border-gray-100">
                    <div class="flex items-start">
                        <div class="practice-icon flex-shrink-0 w-12 h-12 rounded-full bg-blue-100 text-primary flex items-center justify-center text-xl mb-2">
                            <i class="fa-solid fa-image"></i>
                        </div>
                        <div class="ml-4">
                            <div class="flex items-center">
                                <h3 class="practice-name font-bold text-lg">情景题</h3>
                                <span class="practice-tag ml-2 bg-blue-100 text-primary text-xs px-2 py-1 rounded-full">大厂</span>
                                <span class="practice-tag ml-2 bg-blue-100 text-primary text-xs px-2 py-1 rounded-full">国央企</span>
                            </div>
                            <p class="practice-desc2 text-sm text-neutral mt-2">深入讲解，助你学会情景题面试技巧</p>
                        </div>
                    </div>
                </div>

                <div class="practice-item bg-white rounded-xl shadow-lg p-6 hover-scale cursor-pointer border border-gray-100">
                    <div class="flex items-start">
                        <div class="practice-icon flex-shrink-0 w-12 h-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xl mb-2">
                            <i class="fa-solid fa-chart-line"></i>
                        </div>
                        <div class="ml-4">
                            <div class="flex items-center">
                                <h3 class="practice-name font-bold text-lg">综合分析</h3>
                                <span class="practice-tag ml-2 bg-purple-100 text-purple-600 text-xs px-2 py-1 rounded-full">国央企</span>
                                <span class="practice-tag ml-2 bg-purple-100 text-purple-600 text-xs px-2 py-1 rounded-full">银行</span>
                            </div>
                            <p class="practice-desc2 text-sm text-neutral mt-2">熟练此类特殊题型，学会综合分析思路</p>
                        </div>
                    </div>
                </div>

                <div class="practice-item bg-white rounded-xl shadow-lg p-6 hover-scale cursor-pointer border border-gray-100">
                    <div class="flex items-start">
                        <div class="practice-icon flex-shrink-0 w-12 h-12 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center text-xl mb-2">
                            <i class="fa-solid fa-microphone"></i>
                        </div>
                        <div class="ml-4">
                            <div class="flex items-center">
                                <h3 class="practice-name font-bold text-lg">即兴演讲</h3>
                                <span class="practice-tag ml-2 bg-teal-100 text-teal-600 text-xs px-2 py-1 rounded-full">国央企</span>
                                <span class="practice-tag ml-2 bg-teal-100 text-teal-600 text-xs px-2 py-1 rounded-full">银行</span>
                            </div>
                            <p class="practice-desc2 text-sm text-neutral mt-2">深度锻炼表达能力，轻松应对此类考题</p>
                        </div>
                    </div>
                </div>

                <div class="practice-item bg-white rounded-xl shadow-lg p-6 hover-scale cursor-pointer border border-gray-100">
                    <div class="flex items-start">
                        <div class="practice-icon flex-shrink-0 w-12 h-12 rounded-full bg-blue-100 text-primary flex items-center justify-center text-xl mb-2">
                            <i class="fa-solid fa-briefcase"></i>
                        </div>
                        <div class="ml-4">
                            <div class="flex items-center">
                                <h3 class="practice-name font-bold text-lg">个人信息题</h3>
                                <span class="practice-tag ml-2 bg-blue-100 text-primary text-xs px-2 py-1 rounded-full">国央企</span>
                            </div>
                            <p class="practice-desc2 text-sm text-neutral mt-2">教你用面试思维应对对个人信息题</p>
                        </div>
                    </div>
                </div>

                <div class="practice-item bg-white rounded-xl shadow-lg p-6 flex items-center justify-center border border-gray-100 opacity-70">
                    <div class="text-center">
                        <h3 class="practice-name font-bold text-lg text-neutral">更多功能敬请期待</h3>
                    </div>
                </div>
            </div>

            <button class="start-btn-center bg-gradient-secondary text-dark font-bold py-4 px-12 rounded-full text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-yellow-300 text-align:center" id="startBtn" >
                开始面试
            </button>
        </div>
    </div>
</div>

<div class="container hidden" id="mainContainer">
    <!-- 简历上传弹窗 -->
    <div id="resumeUploadModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 animate-fade-in">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-dark">简历智能分析</h2>
                <button onclick="closeResumeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- 左侧：上传区域 -->
                <div class="space-y-6">
                    <div class="upload-area border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-primary transition-colors cursor-pointer" onclick="document.getElementById('resumeImage').click()">
                        <input type="file" class="hidden" id="resumeImage" accept="image/*" required>
                        <div class="space-y-3">
                            <i class="fa-solid fa-cloud-arrow-up text-4xl text-gray-400"></i>
                            <div class="text-gray-600">
                                <p class="font-medium">点击或拖拽上传简历</p>
                                <p class="text-sm mt-1">支持 JPG、PNG 格式，建议图片清晰度不低于 300dpi</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="preview-section">
                        <img id="imagePreview" class="w-full h-auto rounded-lg border border-gray-200 hidden" alt="简历预览">
                    </div>
                </div>
                
                <!-- 右侧：问题输入区域 -->
                <div class="space-y-6">
                    <div class="bg-gray-50 rounded-xl p-6">
                        <div class="flex items-center space-x-3 mb-4">
                            <i class="fa-solid fa-robot text-primary text-xl"></i>
                            <h3 class="text-lg font-medium text-dark">简历分析</h3>
                        </div>
                        <p class="text-gray-600">上传简历后将自动进行分析</p>
                    </div>
                </div>
            </div>
            
            <!-- 加载状态 -->
            <div id="uploadLoading" class="hidden mt-6 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
                <p class="mt-2 text-gray-600">正在分析中，请稍候...</p>
            </div>
        </div>
    </div>

    <!-- 左侧导航栏 -->
    <!-- <div class="sidebar bg-dark text-white w-16 md:w-20 flex flex-col items-center py-8 fixed h-full z-20 transition-all duration-300">
        <div class="avatar w-10 h-10 md:w-12 md:h-12 rounded-full bg-white mb-10 flex items-center justify-center shadow-lg">
            <i class="fa-solid fa-robot text-primary"></i>
        </div>

        <div class="menu flex flex-col items-center gap-6 w-full">
            <div class="menu-item w-10 h-10 md:w-12 md:h-12 rounded-lg bg-primary/20 flex items-center justify-center cursor-pointer hover:bg-primary/30 transition-all">
                <i class="fa-solid fa-home text-lg"></i>
            </div>
            <div class="menu-item w-10 h-10 md:w-12 md:h-12 rounded-lg hover:bg-primary/20 flex items-center justify-center cursor-pointer transition-all">
                <i class="fa-solid fa-calendar-day text-lg"></i>
            </div>
            <div class="menu-item w-10 h-10 md:w-12 md:h-12 rounded-lg hover:bg-primary/20 flex items-center justify-center cursor-pointer transition-all">
                <i class="fa-solid fa-history text-lg"></i>
            </div>
        </div>
    </div> -->

    <!-- 右侧主内容区 -->
    <div class="main-content flex flex-col h-screen">
        <div class="main-header bg-white border-b border-gray-200 px-6 py-4 shadow-sm sticky top-0 z-10">
            <div class="flex justify-between items-center">
                <div class="title text-xl md:text-2xl font-bold text-dark">
                    <i class="fa-solid fa-comments text-primary mr-2"></i>智能面试助手
                </div>
                <div class="flex items-center space-x-3">
                    <!-- 添加进度条组件 -->
                    <div class="progress-container flex items-center space-x-2">
                        <div class="progress-steps flex items-center">
                            <div class="step active">
                                <div class="step-icon">
                                    <i class="fa-solid fa-upload"></i>
                                </div>
                                <div class="step-label">开始分析</div>
                            </div>
                            <div class="step-line"></div>
                            <div class="step">
                                <div class="step-icon">
                                    <i class="fa-solid fa-file-alt"></i>
                                </div>
                                <div class="step-label">简历分析</div>
                            </div>
                            <div class="step-line"></div>
                            <div class="step">
                                <div class="step-icon">
                                    <i class="fa-solid fa-comments"></i>
                                </div>
                                <div class="step-label">面试分析</div>
                            </div>
                            <div class="step-line"></div>
                            <div class="step">
                                <div class="step-icon">
                                    <i class="fa-solid fa-chart-pie"></i>
                                </div>
                                <div class="step-label">总体分析</div>
                            </div>
                        </div>
                    </div>
                    <button id="backToHomeBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-600 font-medium py-2 px-4 rounded-lg shadow transition-all flex items-center">
                        <i class="fa-solid fa-house mr-2"></i>返回主页
                    </button>
                    <button id="clearChatBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-600 font-medium py-2 px-4 rounded-lg shadow transition-all flex items-center">
                        <i class="fa-solid fa-trash-can mr-2"></i>清空记录
                    </button>
                    <button class="download-btn bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg shadow transition-all flex items-center" onclick="gotoresume()">
                        <i class="fa-solid fa-download mr-2"></i>上传简历
                    </button>
                </div>
            </div>
        </div>

        <!-- 四分区布局 -->
        <div class="main-body flex flex-col h-full overflow-hidden">
    <!-- 主要内容区域：三栏布局 -->
    <div class="main-content flex flex-1 overflow-hidden">
        <!-- 左侧区域：AI问题和用户回答（纵向排列） -->
        <div class="left-section w-1/4 bg-white border-r border-gray-200 flex flex-col overflow-y-auto">
            <!-- 第三部分：AI问题区域 -->
            <div class="ai-question-section p-6 border-b border-gray-200" style="height: 300px; overflow-y: auto;">
                <div class="section-title text-xl font-bold text-dark mb-4">
                    <i class="fa-solid fa-robot text-primary mr-2"></i>AI最新问题
                </div>
                
                <div id="aiQuestionContainer" class="bg-gray-50 rounded-xl p-6 min-h-[200px]">
                    <p class="text-neutral italic">AI面试官的问题将显示在这里...</p>
                </div>
            </div>

            <div class="user-answer-section p-6 flex-1 overflow-y-auto" style="height: 400px;">
                <div class="section-title text-xl font-bold text-dark mb-4">
                    <i class="fa-solid fa-user-circle text-primary mr-2"></i>我的最新回答
                </div>
                
                <div id="userAnswerContainer" class="bg-white rounded-xl p-6 min-h-[200px]">
                    <p class="text-neutral italic">点击下方输入框回答AI面试官的问题...</p>
                </div>
            </div>
        </div>
        
        <!-- 中间区域：摄像头和当前AI问题 -->
        <div class="camera-section flex-1">
            <div class="camera-container h-full flex flex-col">
                <div class="camera-wrapper relative flex-1 bg-gray-800 rounded-xl overflow-hidden shadow-lg mb-6">
                    <div id="cameraFeed" class="absolute inset-0 flex items-center justify-center">
                        <div class="camera-placeholder absolute inset-0 flex flex-col items-center justify-center bg-gray-800">
                            <i class="fa-solid fa-video text-6xl text-gray-500 mb-4"></i>
                            <p class="text-gray-400 text-lg">点击下方按钮开启摄像头</p>
                        </div>
                        <video id="videoElement" class="w-full h-full object-cover" autoplay muted></video>
                    </div>
                    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-3">
                        <button id="startCameraBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg shadow transition-all flex items-center">
                            <i class="fa-solid fa-video mr-2"></i>开启摄像头
                        </button>
                        <button id="stopCameraBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg shadow transition-all flex items-center hidden">
                            <i class="fa-solid fa-video-slash mr-2"></i>关闭摄像头
                        </button>
                    </div>
                </div>
                
                <!-- AI问题区域（固定高度并可滚动） -->
                <div class="ai-question bg-white rounded-xl shadow-md p-6" style="height: 200px; overflow-y: auto;">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                            <i class="fa-solid fa-robot text-primary"></i>
                        </div>
                        <div class="ml-4">
                            <h4 class="font-medium text-dark">AI面试官</h4>
                            <div id="currentQuestion" class="mt-2 text-lg font-semibold text-dark">
                                请等待AI面试官提问...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右侧区域：历史对话 -->
        <div class="right-section w-1/4 bg-white border-l border-gray-200 p-6 overflow-y-auto">
            <div class="history-section h-full flex flex-col">
                <div class="section-title text-xl font-bold text-dark mb-4">
                    <i class="fa-solid fa-history text-primary mr-2"></i>历史对话
                </div>
                <div id="chatBody" class="space-y-4 flex-1 scrollbar-hide"></div>
                <div id="historyContainer" class="empty-state bg-gray-50 rounded-xl p-6 text-center hidden">
                    <i class="fa-solid fa-comments text-4xl text-gray-300 mb-4"></i>
                    <p class="text-neutral">暂无对话记录</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 底部区域：输入区域 -->
    <div class="bottom-section border-t border-gray-200 bg-white p-4">
        <!-- 第二部分：底部输入区域 -->
        <div class="input-section">
            <div class="max-w-4xl mx-auto">
                <div class="flex flex-col md:flex-row gap-4">
                    <div id="textInputContainer" class="flex-1">
                        <input type="text" id="chatInput" placeholder="请输入您的回答..." class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                    </div>
                    
                    <div id="audioInputContainer" class="flex-1 hidden">
                        <div class="audio-input bg-gray-100 rounded-lg p-4 flex items-center justify-center">
                            <button id="startRecordingBtn" class="bg-primary hover:bg-primary/90 text-white w-12 h-12 rounded-full flex items-center justify-center shadow transition-all">
                                <i class="fa-solid fa-microphone"></i>
                            </button>
                            <div class="ml-4">
                                <p class="text-neutral">点击麦克风开始录音</p>
                                <p id="recordingStatus" class="text-sm text-gray-500 mt-1">状态：未录音</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-shrink-0 flex gap-3">
                        <button id="textModeBtn" class="bg-primary text-white font-medium py-3 px-6 rounded-lg shadow transition-all hover:bg-primary/90">
                            <i class="fa-solid fa-keyboard mr-2"></i>文字
                        </button>
                        <button id="audioModeBtn" class="bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-lg shadow transition-all hover:bg-gray-300">
                            <i class="fa-solid fa-microphone mr-2"></i>音频
                        </button>
                        <button id="sendBtn" class="bg-secondary hover:bg-secondary/90 text-dark font-medium py-3 px-6 rounded-lg shadow transition-all">
                            <i class="fa-solid fa-paper-plane mr-2"></i>发送
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>    
    </div>
</div>

<script>
    // 用户提供的参数
    const WS_URL = 'wss://spark-openapi.cn-huabei-1.xf-yun.com/v1/assistants/oirgtx7whg9y_v1';
    const APP_ID = '3bf2e419';
    const API_KEY = '0e35ab842bd3a42602b36a462c68f971';
    const API_SECRET = 'MjEzMzNhZjE4NTNjZTljMjZmYjEyM2Uz';
    let qus_ans = [];
    let resume=[]
    let ws;
    let currentBotDiv = null;
    let currentUserMessage = null; // 添加变量存储当前用户消息
    let currentMode = 'text'; // 默认文本模式
    let mediaRecorder = null;
    let audioChunks = [];
    let setAIqustion = null;
    let addToHistory_status=false;
    let isUpload = false
    let analysisResult = null;
    var resumeTime = new Date();
            resumeTime = resumeTime.toLocaleString()
    var time = new Date().toISOString();
    const index=0
    const lines = null;
    // DOM元素
    const chatBody = document.getElementById('chatBody');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const textModeBtn = document.getElementById('textModeBtn');
    const audioModeBtn = document.getElementById('audioModeBtn');
    const textInputContainer = document.getElementById('textInputContainer');
    const audioInputContainer = document.getElementById('audioInputContainer');
    const startRecordingBtn = document.getElementById('startRecordingBtn');
    const recordingStatus = document.getElementById('recordingStatus');
    const currentQuestion = document.getElementById('currentQuestion');
    const userAnswerContainer = document.getElementById('userAnswerContainer');
    const historyContainer = document.getElementById('historyContainer');
    const startOverlay = document.getElementById('startOverlay');
    const mainContainer = document.getElementById('mainContainer');
    const startBtn = document.getElementById('startBtn');
    const clearChatBtn = document.getElementById('clearChatBtn');
    const backToHomeBtn = document.getElementById('backToHomeBtn');
    const startCameraBtn = document.getElementById('startCameraBtn');
    const stopCameraBtn = document.getElementById('stopCameraBtn');
    const videoElement = document.getElementById('videoElement');
    const cameraFeed = document.getElementById('cameraFeed');
    const aiQuestionContainer = document.getElementById('aiQuestionContainer'); // 新增AI问题容器
    let isCandidateQuestion = false;

    // 模拟题库
    // const questionBank = [
    //     {
    //         keywords: ['线程池', '多线程', '并发'],
    //         question: '线程池的原理是什么？',
    //         answer: '线程池通过创建一定数量的线程，当有任务提交时从线程池中获取线程执行任务，任务完成后线程归还线程池，避免频繁创建和销毁线程带来的开销。'
    //     },
    //     {
    //         keywords: ['ArrayList', 'LinkedList', '集合'],
    //         question: 'ArrayList和LinkedList的底层数据结构分别是什么？',
    //         answer: 'ArrayList底层是动态数组，LinkedList底层是双向链表。'
    //     },
    //     {
    //         keywords: ['@Transactional', '事务'],
    //         question: '使用@Transactional注解的条件是什么？',
    //         answer: '需要在Spring框架中，方法所在类要被Spring管理，方法为public等基本条件。'
    //     },
    //     {
    //         keywords: ['异常', '稳定', '上线'],
    //         question: '在项目中使用Spring MVC Controller时，如何处理异常并保证系统稳定上线？',
    //         answer: '需结合全局异常处理器、日志记录等方式处理异常，通过测试、监控等手段保障系统稳定上线。'
    //     }
    // ];
    
    // 页面初始化
    function init() {
        // 连接WebSocket
        connectWebSocket();
        
        // 绑定事件
        sendBtn.onclick = sendMessage;
        chatInput.onkeydown = function(e) {
            if (e.key === 'Enter') sendMessage();
        };
        textModeBtn.onclick = switchToTextMode;
        audioModeBtn.onclick = switchToAudioMode;
        startRecordingBtn.onclick = toggleRecording;
        startBtn.onclick = startInterview;
        clearChatBtn.onclick = clearChat;
        backToHomeBtn.onclick = backToHome;
        startCameraBtn.onclick = startCamera;
        stopCameraBtn.onclick = stopCamera;
        
    
    }
    
    // 连接WebSocket
    function connectWebSocket() {
        ws = new WebSocket(WS_URL);
        ws.onopen = function() {
            console.log('WebSocket已连接');
        };
        
      ws.onmessage = function(event) {
        const response = JSON.parse(event.data);
        const messages = response.payload.choices.text;
        
        // 处理新回答时，先检查是否有正在进行的用户消息
        if (!currentUserMessage) return; // 无对应问题时忽略回答

        if (!currentBotDiv) {
            currentBotDiv = document.createElement('div');
            currentBotDiv.className = 'flex items-start mb-6 animate-fade-in';
            currentBotDiv.innerHTML = `
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                    <i class="fa-solid fa-robot text-primary"></i>
                </div>
                <div class="ml-3 max-w-[85%]">
                    <h4 class="font-medium text-dark">AI面试官</h4>
                    <div class="bg-blue-50 mt-1 p-4 rounded-xl text-neutral">
                        <span class="bot-message"></span>
                    </div>
                </div>
            `;

            chatBody.scrollTop = chatBody.scrollHeight;
        }
        
        // 更新AI回答
        messages.forEach((msg, index) => {
            let content = msg.content;
            console.log(content)
            if (content.length>0){
                const charts = [...content]
                // 只处理第一条消息，并检查是否包含逗号
                if (charts[0].includes("，")) {
                    // 提取逗号后面的内容
                    const parts = charts[0].replace("，","");
                    content = charts.join('');
                }else{
                    content =charts.join('');
                }
            }
            currentBotDiv.querySelector('.bot-message').textContent += content + ' ';
        });
        
        // 回答完成
        if (response.payload.choices.status === 2) {
            const botAnswer = currentBotDiv.querySelector('.bot-message').textContent.trim();
            
            // 更新当前问题和回答区域
            if(botAnswer.includes("总结")||botAnswer.includes("结束")&&(botAnswer.includes("专业知识")||botAnswer.includes("项目经验")||botAnswer.includes("问题解决")||botAnswer.includes("沟通表达"))){
                addToHistory(currentUserMessage, botAnswer);
                currentQuestion.textContent = botAnswer;
                currentUserMessage = null;
                currentBotDiv = null;
                return
            }
            currentQuestion.textContent = botAnswer;
            updateAIQuestionContainer(botAnswer);
            updateUserAnswerContainer(currentUserMessage);
            // 添加到历史对话
            addToHistory(currentUserMessage, botAnswer);
            
            // 重置状态
            currentUserMessage = null;
            currentBotDiv = null;
        }
        
        chatBody.scrollTop = chatBody.scrollHeight;
    };
        
        ws.onerror = function(err) {
            console.log('WebSocket错误', err);
        };
        
        ws.onclose = function() {
            console.log('WebSocket已关闭，尝试重连...');
            setTimeout(connectWebSocket, 1000);
        };
    }
    
    // 发送消息
    function sendMessage() {
    if (currentMode === 'text') {
        const text = chatInput.value.trim();
        if (!text || ws.readyState !== WebSocket.OPEN) return;
        
        // 保存当前用户消息
        currentUserMessage = text;
        
        // 交换调用
        updateUserAnswerContainer(text);
        
        // 发送消息
        const message = {
            "header": {
                "app_id": APP_ID,
                "uid": "user-001"
            },
            "parameter": {
                "chat": {
                    "domain": "general",
                    "temperature": 0.5,
                    "top_k": 4,
                    "max_tokens": 1024
                }
            },
            "payload": {
                "message": {
                    "text": [
                        {
                            "role": "user",
                            "content": text
                        }
                    ]
                }
            }
        };
        ws.send(JSON.stringify(message));
        chatInput.value = '';
        } else if (currentMode === 'audio') {
            // 音频模式下，需要先处理音频数据
            if (audioChunks.length === 0) {
                alert('请先录制音频');
                return;
            }
            
            // 模拟音频上传和处理
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            
            // 保存当前用户消息
            currentUserMessage = '[音频回答]';
            
            // 交换调用
            updateAIQuestionContainer(`<audio controls><source src="${audioUrl}" type="audio/wav">您的浏览器不支持音频播放</audio>`);
            
            // 模拟发送音频消息
            setTimeout(() => {
                // 这里应该是实际发送音频到服务器的代码
                // 这里仅作演示，发送一个文本消息代替
                const message = {
                    "header": {
                        "app_id": APP_ID,
                        "uid": "user-001"
                    },
                    "parameter": {
                        "chat": {
                            "domain": "general",
                            "temperature": 0.5,
                            "top_k": 4,
                            "max_tokens": 1024
                        }
                    },
                    "payload": {
                        "message": {
                            "text": [
                                {
                                    "role": "user",
                                    "content": "我刚刚发送了一段音频回答"
                                }
                            ]
                        }
                    }
                };
                ws.send(JSON.stringify(message));
                
                // 重置音频
                audioChunks = [];
                recordingStatus.textContent = '状态：未录音';
                startRecordingBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
            }, 1000);
        }
    }
    
    // 切换到文本模式
    function switchToTextMode() {
        if (currentMode === 'text') return;
        
        currentMode = 'text';
        textModeBtn.classList.remove('bg-gray-200', 'text-gray-700');
        textModeBtn.classList.add('bg-primary', 'text-white');
        audioModeBtn.classList.remove('bg-primary', 'text-white');
        audioModeBtn.classList.add('bg-gray-200', 'text-gray-700');
        textInputContainer.classList.remove('hidden');
        audioInputContainer.classList.add('hidden');
        
        // 重置音频录制状态
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        audioChunks = [];
        recordingStatus.textContent = '状态：未录音';
        startRecordingBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
    }
    
    // 切换到音频模式
    function switchToAudioMode() {
        if (currentMode === 'audio') return;
        
        // 检查浏览器支持
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('您的浏览器不支持音频录制功能');
            return;
        }
        
        currentMode = 'audio';
        audioModeBtn.classList.remove('bg-gray-200', 'text-gray-700');
        audioModeBtn.classList.add('bg-primary', 'text-white');
        textModeBtn.classList.remove('bg-primary', 'text-white');
        textModeBtn.classList.add('bg-gray-200', 'text-gray-700');
        audioInputContainer.classList.remove('hidden');
        textInputContainer.classList.add('hidden');
    }
    
    // 开始/停止录音
    function toggleRecording() {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
            // 开始录音
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.addEventListener('dataavailable', event => {
                        audioChunks.push(event.data);
                    });
                    
                    mediaRecorder.addEventListener('stop', () => {
                        // 录音停止后的处理
                        recordingStatus.textContent = '状态：已录制，点击发送按钮上传';
                        startRecordingBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
                    });
                    
                    mediaRecorder.start();
                    recordingStatus.textContent = '状态：正在录音...';
                    startRecordingBtn.innerHTML = '<i class="fa-solid fa-stop"></i>';
                })
                .catch(error => {
                    console.error('录音错误:', error);
                    alert('无法访问麦克风，请检查权限设置');
                });
        } else {
            // 停止录音
            mediaRecorder.stop();
        }
    }
    
    // 开始面试
    function startInterview() {
        // 添加按钮点击效果
        startBtn.classList.add('scale-95');
        setTimeout(() => {
            startBtn.classList.remove('scale-95');
        }, 150);

        // 初始化进度条
        updateProgress(0);

        // 页面切换动画
        startOverlay.classList.add('opacity-0', 'pointer-events-none');
        startOverlay.style.transition = 'opacity 0.5s ease-in-out';

        setTimeout(function() {
            startOverlay.style.display = 'none';
            mainContainer.classList.remove('hidden');
            mainContainer.classList.add('animate-fade-in');

            // 延迟显示提示
            setTimeout(function() {
                console.log('请先上传简历');
            }, 800);
        }, 500);
    }
    
    // 清空聊天记录
    function clearChat() {
        const confirmDialog = document.createElement('div');
        confirmDialog.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50';
        confirmDialog.innerHTML = `
            <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 animate-fade-in">
                <h3 class="text-lg font-bold text-dark mb-4">确认清空</h3>
                <p class="text-neutral mb-6">确定要清空所有聊天记录吗？此操作不可恢复。</p>
                <div class="flex justify-end space-x-3">
                    <button class="cancel-btn px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 transition-all">
                        取消
                    </button>
                    <button class="confirm-btn px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white transition-all">
                        确认清空
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(confirmDialog);
        confirmDialog.querySelector('.confirm-btn').onclick = function() {
            // 关闭现有WebSocket连接
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            resetUploadForm()
            chatBody.innerHTML = '';
            // 显示空状态提示
            document.getElementById('historyContainer').classList.remove('hidden');
            // 清空题目区
            historyContainer.innerHTML = `
                <div class="empty-state bg-white rounded-xl p-6 text-center">
                    <i class="fa-solid fa-comments text-4xl text-gray-300 mb-4"></i>
                    <p class="text-neutral">暂无对话记录</p>
                </div>
            `;
            
            // 重置所有状态变量
            currentUserMessage = null;
            currentBotDiv = null;
            setAIqustion = null;
            showaddToHistory = false
            qus_ans = []; // 清空问答数组
            
            // 重置AI问题和用户回答容器
            aiQuestionContainer.innerHTML = `<p class="text-neutral italic">AI面试官的问题将显示在这里...</p>`;
            userAnswerContainer.innerHTML = `<p class="text-neutral italic">点击下方输入框回答AI面试官的问题...</p>`;
            
            // 显示清空成功提示
            const successMessage = document.createElement('div');
            successMessage.className = 'flex items-start mb-6 animate-fade-in';
            successMessage.innerHTML = `
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                    <i class="fa-solid fa-check text-green-500"></i>
                </div>
                <div class="ml-3 max-w-[85%]">
                    <h4 class="font-medium text-green-500">系统提示</h4>
                    <div class="bg-green-50 mt-1 p-4 rounded-xl text-green-600">
                        聊天记录已清空，当前为全新会话
                    </div>
                </div>
            `;
            chatBody.appendChild(successMessage);
            chatBody.scrollTop = chatBody.scrollHeight;

            // 移除确认对话框
            document.body.removeChild(confirmDialog);
            
            // 重新连接WebSocket
            setTimeout(connectWebSocket, 1000);
        };
        
        confirmDialog.querySelector('.cancel-btn').onclick = function() {
            document.body.removeChild(confirmDialog);
        };
    }
    
    // 返回主页
    function backToHome() {
        // 显示确认对话框
        const confirmDialog = document.createElement('div');
        confirmDialog.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50';
        confirmDialog.innerHTML = `
            <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 animate-fade-in">
                <h3 class="text-lg font-bold text-dark mb-4">确认返回</h3>
                <p class="text-neutral mb-6">确定要返回主页吗？当前对话记录将会被清空。</p>
                <div class="flex justify-end space-x-3">
                    <button class="cancel-btn px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 transition-all">
                        取消
                    </button>
                    <button class="confirm-btn px-4 py-2 rounded-lg bg-primary hover:bg-primary/90 text-white transition-all">
                        确认返回
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(confirmDialog);

        // 绑定取消按钮事件
        confirmDialog.querySelector('.cancel-btn').onclick = function() {
            document.body.removeChild(confirmDialog);
        };

        // 绑定确认按钮事件
        confirmDialog.querySelector('.confirm-btn').onclick = function() {
            // 关闭确认对话框
            document.body.removeChild(confirmDialog);

            // 跳转到 home.html
            window.location.href = '../home/home.html';
        };
    }
    
    // 开始摄像头
    function startCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('您的浏览器不支持摄像头功能');
            return;
        }
        
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                videoElement.srcObject = stream;
                videoElement.style.display = 'block';
                document.querySelector('.camera-placeholder').style.display = 'none';
                startCameraBtn.classList.add('hidden');
                stopCameraBtn.classList.remove('hidden');
            })
            .catch(error => {
                console.error('摄像头错误:', error);
                alert('无法访问摄像头，请检查权限设置');
            });
    }
    
    // 停止摄像头
    function stopCamera() {
        if (videoElement.srcObject) {
            videoElement.srcObject.getTracks().forEach(track => track.stop());
            videoElement.srcObject = null;
            videoElement.style.display = 'none';
            document.querySelector('.camera-placeholder').style.display = 'block';
            stopCameraBtn.classList.add('hidden');
            startCameraBtn.classList.remove('hidden');
        }
    }
    
    // 将面试的问题和答案存储到redis
    async function sendTotalMessage(question_answer){
        updateProgress(1);
        submitResume()
        const response = await fetch('http://localhost:8086/Metting/UserMeeting')
    }
    // 对简历的数据进行处理
    async function solveResume() {
        lines = analysisResult.split('\n');
        console.log(lines.length);
        const keywords=["**评测对象**","**目标岗位**","**优势**","**待改进项**","**竞争力定位**","（一）专业知识水平","正向加分项","负向减分项","**得分**","（二）技能匹配度","（三）语言表达能力","（四）逻辑思维能力","（五）创新能力"]
        for (let i = 0; i < lines.length; i++){
            const line = lines[i].trim();
            processedLines = lines.map(line => line.trim());
        }
        console.log(processedLines.length)
        for (index=0;index<processedLines.length;index++){
            const line = processedLines[index];
            checkLine(line,keywords)
        }
        function calculateScores() {
            if (!knowledgeScore || !skillsScore || !communicationScore || !logicScore || !innovationScore) {
            markTotal = "N/A";
            return;
            }

            const scores = [knowledgeScore, skillsScore, communicationScore, logicScore, innovationScore];
            const totalMarks = scores.map(score => parseInt(score.split('/')[0], 10) || 0);
            markTotal = totalMarks.reduce((acc, curr) => acc + curr, 0);
        }
        calculateScores();
        function checkLine(line, keywords) {
            switch(true){
            case line.includes(keywords[0]):
                console.log("匹配到"+keywords[0])
                resume_name =line.split("：")[1].trim()
                console.log(resume_name)
                break;
            case line.includes(keywords[1]):
                console.log("匹配到"+keywords[1])
                resume_position =line.split("：")[1].trim()
                console.log(resume_position)
                break;
            case line.includes(keywords[2]):
                console.log("匹配到"+keywords[2])
                let strengthsIndex = index+1;
                while (strengthsIndex < processedLines.length) {
                const line = processedLines[strengthsIndex];

                // 如果行不包含任何关键词，则处理它
                if (!keywords.some(keyword => line.includes(keyword))) {
                    // 处理逻辑：分割并取第二部分，移除星号
                    const parts = line.split(".");
                    if (parts.length > 1) { // 确保有第二部分
                    const processedLine = parts[1].trim().replaceAll("*", "");
                    resume_strengths.push(processedLine)

                    // 这里可以添加进一步的处理逻辑，例如保存结果
                    }
                    strengthsIndex++; // 继续处理下一行
                } else {
                    break; // 遇到关键词，停止处理
                }
                }
                console.log(resume_strengths)
                break;
            case line.includes(keywords[3]):
                console.log("匹配到"+keywords[3])
                let improvementsIndex = index+1;
                while (improvementsIndex < processedLines.length) {
                const line = processedLines[improvementsIndex];

                // 如果行不包含任何关键词，则处理它
                if (!keywords.some(keyword => line.includes(keyword))) {
                    // 处理逻辑：分割并取第二部分，移除星号
                    const parts = line.split(".");
                    if (parts.length > 1) { // 确保有第二部分
                    const processedLine = parts[1].trim().replaceAll("*", "");
                    resume_improvements.push(processedLine)

                    // 这里可以添加进一步的处理逻辑，例如保存结果
                    }
                    improvementsIndex++; // 继续处理下一行
                } else {
                    break; // 遇到关键词，停止处理
                }
                }
                console.log(resume_improvements)
                break;
            case line.includes(keywords[4]):
                console.log("匹配到"+keywords[4])
                let competitivenessIndex = index+1;
                while (competitivenessIndex < processedLines.length) {
                const line = processedLines[competitivenessIndex];
                let processedLine = line
                // 如果行不包含任何关键词，则处理它
                if (!keywords.some(keyword => line.includes(keyword))) {
                    if (line.includes("*")){
                    processedLine  = processedLine.replaceAll("*","")
                    resume_competitiveness.push(processedLine)
                    }
                    else{
                    resume_competitiveness.push(processedLine)
                    }
                    // 这里可以添加进一步的处理逻辑，例如保存结果
                    competitivenessIndex++; // 继续处理下一行
                } else {
                    break; // 遇到关键词，停止处理
                }
                }
                console.log(resume_competitiveness)
                break;
            case line.includes(keywords[5]):
                console.log("匹配到"+keywords[5]);
                let knowledgeIndex = index + 1;
                let knowledgePositiveSection = false;
                let knowledgeNegativeSection = false;

                while (knowledgeIndex < processedLines.length) {
                const currentLine = processedLines[knowledgeIndex];

                // 检测是否进入正向加分项部分
                if (currentLine.includes(keywords[6])) {
                    knowledgePositiveSection = true;
                    knowledgeNegativeSection = false;
                    knowledgeIndex++;
                    continue;
                }

                // 检测是否进入负向减分项部分
                if (currentLine.includes(keywords[7])) {
                    knowledgePositiveSection = false;
                    knowledgeNegativeSection = true;
                    knowledgeIndex++;
                    continue;
                }

                // 处理正向加分项
                if (knowledgePositiveSection && !currentLine.includes(keywords[8])) {
                    const parts = currentLine.split(/\.\s+/, 2);
                    if (parts.length > 1) {
                    knowledge_positiveItems.push(parts[1].trim());
                    console.log("正向加分项:", parts[1].trim());
                    }
                }

                // 处理负向减分项
                if (knowledgeNegativeSection && !currentLine.includes(keywords[8])) {
                    const parts = currentLine.split(/\.\s+/, 2);
                    if (parts.length > 1) {
                    knowledge_negativeItems.push(parts[1].trim());
                    console.log("负向减分项:", parts[1].trim());
                    }
                }

                // 处理得分
                if (currentLine.includes(keywords[8])) {
                    const parts = currentLine.split("：");
                    if (parts.length > 1) {
                    knowledgeScore = parts[1].trim().substring(0, 5);
                    console.log("得分:", knowledgeScore);
                    }
                    knowledgePositiveSection = false;
                    knowledgeNegativeSection = false;
                }

                // 检测是否离开当前部分
                if (currentLine.includes(keywords[9])) {
                    break;
                }

                knowledgeIndex++;
                }
                break;
            case line.includes(keywords[10]):
                console.log("匹配到"+keywords[10]);
                let communicationIndex = index + 1;
                let communicationPositiveSection = false;
                let communicationNegativeSection = false;

                while (communicationIndex < processedLines.length) {
                const currentLine = processedLines[communicationIndex];

                // 检测是否进入正向加分项部分
                if (currentLine.includes(keywords[6])) {
                    communicationPositiveSection  = true;
                    communicationNegativeSection = false;
                    communicationIndex++;
                    continue;
                }

                // 检测是否进入负向减分项部分
                if (currentLine.includes(keywords[7])) {
                    communicationPositiveSection  = false;
                    communicationNegativeSection = true;
                    communicationIndex++;
                    continue;
                }

                // 处理正向加分项
                if (communicationPositiveSection  && !currentLine.includes(keywords[8])) {
                    const parts = currentLine.split(/\.\s+/, 2);
                    if (parts.length > 1) {
                    communication_positiveItems.push(parts[1].trim());
                    console.log("正向加分项:", parts[1].trim());
                    }
                }

                // 处理负向减分项
                if (communicationNegativeSection && !currentLine.includes(keywords[8])) {
                    const parts = currentLine.split(/\.\s+/, 2);
                    if (parts.length > 1) {
                    communication_negativeItems.push(parts[1].trim());
                    console.log("负向减分项:", parts[1].trim());
                    }
                }

                // 处理得分
                if (currentLine.includes(keywords[8])) {
                    const parts = currentLine.split("：");
                    if (parts.length > 1) {
                    communicationScore = parts[1].trim().substring(0, 5);
                    console.log("得分:", communicationScore);
                    }
                    communicationPositiveSection  = false;
                    communicationNegativeSection = false;
                }

                // 检测是否离开当前部分
                if (currentLine.includes(keywords[11])) {
                    break;
                }

                communicationIndex++;
                }
                break;
            case line.includes(keywords[9]):
                console.log("匹配到"+keywords[9]);
                let skillsIndex = index + 1;
                let skillsPositiveSection = false;
                let skillsNegativeSection = false;

                while (skillsIndex < processedLines.length) {
                const currentLine = processedLines[skillsIndex];

                // 检测是否进入正向加分项部分
                if (currentLine.includes(keywords[6])) {
                    skillsPositiveSection = true;
                    skillsNegativeSection = false;
                    skillsIndex++;
                    continue;
                }

                // 检测是否进入负向减分项部分
                if (currentLine.includes(keywords[7])) {
                    skillsPositiveSection = false;
                    skillsNegativeSection = true;
                    skillsIndex++;
                    continue;
                }

                // 处理正向加分项
                if (skillsPositiveSection && !currentLine.includes(keywords[8])) {
                    const parts = currentLine.split(/\.\s+/, 2);
                    if (parts.length > 1) {
                    skills_positiveItems.push(parts[1].trim());
                    console.log("正向加分项:", parts[1].trim());
                    }
                }

                // 处理负向减分项
                if (skillsNegativeSection && !currentLine.includes(keywords[8])) {
                    const parts = currentLine.split(/\.\s+/, 2);
                    if (parts.length > 1) {
                    skills_negativeItems.push(parts[1].trim());
                    console.log("负向减分项:", parts[1].trim());
                    }
                }

                // 处理得分
                if (currentLine.includes(keywords[8])) {
                    const parts = currentLine.split("：");
                    if (parts.length > 1) {
                    skillsScore = parts[1].trim().substring(0, 5);
                    console.log("得分:",skillsScore);
                    }
                    skillsPositiveSection = false;
                    skillsNegativeSection = false;
                }

                // 检测是否离开当前部分
                if (currentLine.includes(keywords[10])) {
                    break;
                }

                skillsIndex++;
                }
                break;
            case line.includes(keywords[11]):
                console.log("匹配到"+keywords[11]);
                let logicIndex = index + 1;
                let logicPositiveSection = false;
                let logicNegativeSection = false;

                while (logicIndex < processedLines.length) {
                const currentLine = processedLines[logicIndex];

                // 检测是否进入正向加分项部分
                if (currentLine.includes(keywords[6])) {
                    logicPositiveSection = true;
                    logicNegativeSection = false;
                    logicIndex++;
                    continue;
                }

                // 检测是否进入负向减分项部分
                if (currentLine.includes(keywords[7])) {
                    logicPositiveSection = false;
                    logicNegativeSection = true;
                    logicIndex++;
                    continue;
                }

                // 处理正向加分项
                if (logicPositiveSection && !currentLine.includes(keywords[8])) {
                    const parts = currentLine.split(/\.\s+/, 2);
                    if (parts.length > 1) {
                    logic_positiveItems.push(parts[1].trim());
                    console.log("正向加分项:", parts[1].trim());
                    }
                }

                // 处理负向减分项
                if (logicNegativeSection && !currentLine.includes(keywords[8])) {
                    const parts = currentLine.split(/\.\s+/, 2);
                    if (parts.length > 1) {
                    logic_negativeItems.push(parts[1].trim());
                    console.log("负向减分项:", parts[1].trim());
                    }
                }

                // 处理得分
                if (currentLine.includes(keywords[8])) {
                    const parts = currentLine.split("：");
                    if (parts.length > 1) {
                    logicScore = parts[1].trim().substring(0, 5);
                    console.log("得分:",logicScore);
                    }
                    logicPositiveSection = false;
                    logicNegativeSection = false;
                }

                // 检测是否离开当前部分
                if (currentLine.includes(keywords[12])) {
                    break;
                }
                logicIndex++;
                }
                break;
            case line.includes(keywords[12]):
                console.log("匹配到"+keywords[12]);
                let innovationIndex = index + 1;
                let innovationPositiveSection = false;
                let innovationNegativeSection = false;

                while (innovationIndex < processedLines.length) {
                const currentLine = processedLines[innovationIndex];

                // 检测是否进入正向加分项部分
                if (currentLine.includes(keywords[6])) {
                    innovationPositiveSection = true;
                    innovationNegativeSection = false;
                    innovationIndex++;
                    continue;
                }

                // 检测是否进入负向减分项部分
                if (currentLine.includes(keywords[7])) {
                    innovationPositiveSection = false;
                    innovationNegativeSection = true;
                    innovationIndex++;
                    continue;
                }

                // 处理正向加分项
                if (innovationPositiveSection && !currentLine.includes(keywords[8])) {
                    const parts = currentLine.split(/\.\s+/, 2);
                    if (parts.length > 1) {
                    innovation_positiveItems.push(parts[1].trim());
                    console.log("正向加分项:", parts[1].trim());
                    }
                }

                // 处理负向减分项
                if (innovationNegativeSection && !currentLine.includes(keywords[8])) {
                    const parts = currentLine.split(/\.\s+/, 2);
                    if (parts.length > 1) {
                    innovation_negativeItems.push(parts[1].trim());
                    console.log("负向减分项:", parts[1].trim());
                    }
                }

                // 处理得分
                if (currentLine.includes(keywords[8])) {
                    const parts = currentLine.split("：");
                    if (parts.length > 1) {
                    innovationScore = parts[1].trim().substring(0, 5);
                    console.log("得分:",innovationScore);
                    }
                    innovationPositiveSection = false;
                    innovationNegativeSection = false;
                    
                    return;
                }
                // 检测是否离开当前部分
                if (currentLine.includes(keywords[12])) {
                    break;
                }
                innovationIndex++;
                }
                break;
            default:
            console.log("无关行")
            }
        }
    } 

    // 添加到历史对话
    function addToHistory(userAnswer, aiQuestion) {
    // 首次添加时，隐藏空状态提示
        if(addToHistory_status==true){
            if(aiQuestion.includes("总结")&&aiQuestion.includes("结束")&&(aiQuestion.includes("专业知识")||aiQuestion.includes("项目经验")||aiQuestion.includes("问题解决")||aiQuestion.includes("沟通表达"))){
                qus_ans.push({
                    question:setAIqustion,
                    answer:userAnswer
                })
                qus_ans.push({
                    question:aiQuestion
                })
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item bg-white rounded-xl shadow-md p-6 animate-fade-in';
                chatItem.innerHTML = `
                    <!-- AI 问题 -->
                    <div class="bot-message">
                        <div class="flex items-center mb-2">
                            <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center mr-2">
                                <i class="fa-solid fa-robot text-primary text-sm"></i>
                            </div>
                            <span class="font-medium text-dark">AI面试官：</span>
                        </div>
                        <div class="text-neutral pl-10">${aiQuestion}</div>
                    </div>
                    <div class="mt-3 text-xs text-gray-400 text-right">
                        ${new Date().toLocaleString()}
                    </div>
                `;
                addToHistory_status=false
                chatBody.appendChild(chatItem);
                sendTotalMessage(qus_ans)
                return
            }
            showaddToHistory(userAnswer, aiQuestion)
        }
        if(addToHistory_status==false&&(userAnswer.includes("大数据")||userAnswer.includes("物联网")||userAnswer.includes("智能"))){
            showaddToHistory(userAnswer, aiQuestion)    
        }
        else{
            setAIqustion = aiQuestion
        }
        chatBody.scrollTop = chatBody.scrollHeight;
    }
    function showaddToHistory(userAnswer, aiQuestion){
        qus_ans.push({
            question:setAIqustion,
            answer:userAnswer
        })
        if (chatBody.children.length === 0) {
        document.getElementById('historyContainer').classList.remove('hidden');
        } else {
            document.getElementById('historyContainer').classList.add('hidden');
        }
        // 创建用户回答和 AI 问题的容器
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item bg-white rounded-xl shadow-md p-6 animate-fade-in';
        chatItem.innerHTML = `
            <!-- AI 问题 -->
            <div class="bot-message">
                <div class="flex items-center mb-2">
                    <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center mr-2">
                        <i class="fa-solid fa-robot text-primary text-sm"></i>
                    </div>
                    <span class="font-medium text-dark">AI面试官：</span>
                </div>
                <div class="text-neutral pl-10">${setAIqustion}</div>
            </div>
            <!-- 用户回答 -->
            <div class="user-message mb-4">
                <div class="flex items-center mb-2">
                    <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-2">
                        <i class="fa-solid fa-user text-neutral text-sm"></i>
                    </div>
                    <span class="font-medium text-dark">我的回答：</span>
                </div>
                <div class="text-neutral pl-10">${userAnswer}</div>
            </div>

            <div class="mt-3 text-xs text-gray-400 text-right">
                ${new Date().toLocaleString()}
            </div>
        `;
        setAIqustion = aiQuestion
        addToHistory_status=true
        chatBody.appendChild(chatItem);
    }
    // 更新AI问题容器
    function updateAIQuestionContainer(content) {
        aiQuestionContainer.innerHTML = `<p class="text-neutral">${content}</p>`;
    }

    // 更新用户回答容器
    function updateUserAnswerContainer(content) {
        userAnswerContainer.innerHTML = `<p class="text-neutral">${content}</p>`;
    }
    
    // 上传简历
    function gotoresume() {
        document.getElementById('resumeUploadModal').classList.remove('hidden');
    }
    
    // 关闭简历上传弹窗
    function closeResumeModal() {
        document.getElementById('resumeUploadModal').classList.add('hidden');
        // // 重置表单
        // document.getElementById('uploadForm').reset();
        // document.getElementById('imagePreview').classList.add('hidden');
    }

    // 修改图片预览功能
    document.getElementById('resumeImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                // 更新上传区域样式
                document.querySelector('.upload-area').classList.add('border-primary');
                isUpload =true
                // 自动提交分析
                closeResumeModal();
            }
            reader.readAsDataURL(file);
        }
    });

    // 添加拖拽上传功能
    const uploadArea = document.querySelector('.upload-area');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        uploadArea.classList.add('border-primary');
    }

    function unhighlight(e) {
        uploadArea.classList.remove('border-primary');
    }

    uploadArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const file = dt.files[0];
        
        if (file && file.type.startsWith('image/')) {
            const input = document.getElementById('resumeImage');
            input.files = dt.files;
            // 触发change事件
            const event = new Event('change');
            input.dispatchEvent(event);
        }
    }

    // 修改提交简历分析函数
    async function submitResume() {
        const imageFile = document.getElementById('resumeImage').files[0];

        if (!imageFile) {
            return;
        }

        // 更新进度条到简历分析步

        const formData = new FormData();
        formData.append('file', imageFile);
        formData.append('question', '分析我的简历');

        try {
            const response = await fetch('http://localhost:8086/api/resume/analyze', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const result = await response.text();
                analysisResult =result
            } else {
                throw new Error('分析失败，请稍后重试');
            }
        } catch (error) {
            alert('分析失败：' + error.message);
        } finally {
            // 隐藏加载状态
            // document.getElementById('uploadLoading').classList.add('hidden');
        }
    }
    function resetUploadForm() {
        const form = document.getElementById('resumeUploadModal');
        // form.reset(); // 重置所有表单字段
        document.getElementById('imagePreview').classList.add('hidden');
        document.getElementById('imagePreview').src = ''; // 清空预览图
        document.querySelector('.upload-area').classList.remove('border-primary');
        isUpload = false; // 重置上传状态
    }
    
    // 初始化页面
    document.addEventListener('DOMContentLoaded', init);

    // 进度条控制函数
    function updateProgress(step) {
        const steps = document.querySelectorAll('.step');
        const lines = document.querySelectorAll('.step-line');
        
        // 重置所有步骤
        steps.forEach(s => s.classList.remove('active'));
        lines.forEach(l => l.classList.remove('active'));
        
        // 激活当前步骤及之前的步骤
        for(let i = 0; i <= step; i++) {
            steps[i].classList.add('active');
            if(i < step) {
                lines[i].classList.add('active');
            }
        }
    }
</script>
</body>
</html>